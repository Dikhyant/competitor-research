<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Competitor Spy - Discover Competitors & Market Trends</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #0a0e27;
            background-image: 
                radial-gradient(at 0% 0%, rgba(0, 217, 255, 0.1) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(0, 184, 212, 0.1) 0px, transparent 50%);
            min-height: 100vh;
            color: #e0e0e0;
            padding: 40px 20px;
        }

        .container {
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            text-align: center;
            margin-bottom: 50px;
        }

        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            border: 2px solid #00d9ff;
            border-radius: 50%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-icon::before {
            content: '';
            width: 20px;
            height: 20px;
            border: 2px solid #00d9ff;
            border-radius: 50%;
            position: absolute;
        }

        .logo-icon::after {
            content: '';
            width: 8px;
            height: 8px;
            background: #00d9ff;
            border-radius: 50%;
            position: absolute;
        }

        h1 {
            color: #00d9ff;
            font-size: 3em;
            font-weight: 700;
            margin: 0;
            letter-spacing: -0.5px;
        }

        .subtitle {
            text-align: center;
            color: #a0a0a0;
            margin-bottom: 50px;
            font-size: 1.1em;
            font-weight: 400;
        }

        .search-section {
            display: flex;
            gap: 12px;
            max-width: 800px;
            margin: 0 auto 60px;
            align-items: stretch;
        }

        .form-group {
            flex: 1;
            position: relative;
        }

        .search-input-wrapper {
            position: relative;
            width: 100%;
        }

        .search-icon {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            color: #00d9ff;
            pointer-events: none;
        }

        .search-icon svg {
            width: 100%;
            height: 100%;
            fill: currentColor;
        }

        input[type="url"] {
            width: 100%;
            padding: 18px 20px 18px 55px;
            background: rgba(20, 30, 60, 0.8);
            border: 2px solid rgba(0, 217, 255, 0.3);
            border-radius: 12px;
            font-size: 1em;
            color: #e0e0e0;
            transition: all 0.3s ease;
            outline: none;
        }

        input[type="url"]::placeholder {
            color: #6b7280;
        }

        input[type="url"]:focus {
            border-color: #00d9ff;
            box-shadow: 0 0 0 3px rgba(0, 217, 255, 0.1);
            background: rgba(20, 30, 60, 0.95);
        }

        .btn {
            padding: 18px 35px;
            background: #00d9ff;
            color: #0a0e27;
            border: none;
            border-radius: 12px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .btn-icon {
            width: 18px;
            height: 18px;
            border: 2px solid #0a0e27;
            border-radius: 50%;
            position: relative;
            display: inline-block;
        }

        .btn-icon::before {
            content: '';
            width: 10px;
            height: 10px;
            border: 2px solid #0a0e27;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .btn:hover:not(:disabled) {
            background: #00c4e6;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 217, 255, 0.3);
        }

        .btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .ready-section {
            text-align: center;
            margin: 40px auto;
            max-width: 600px;
            display: none;
        }

        .ready-section.active {
            display: block;
        }

        .ready-icon {
            width: 80px;
            height: 80px;
            background: rgba(0, 217, 255, 0.1);
            border: 2px solid rgba(0, 217, 255, 0.3);
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
        }

        .ready-text {
            font-size: 1.2em;
            font-weight: 600;
            color: #e0e0e0;
            margin-bottom: 15px;
        }

        .ready-description {
            color: #a0a0a0;
            font-size: 0.95em;
            line-height: 1.6;
        }

        .loading {
            display: none;
            text-align: center;
            margin-top: 40px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 3px solid rgba(0, 217, 255, 0.2);
            border-top: 3px solid #00d9ff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results {
            display: none;
            margin-top: 60px;
            animation: fadeIn 0.5s ease-in;
        }

        .results.active {
            display: block;
        }

        .results-header {
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }

        .results-header h2 {
            color: #e0e0e0;
            font-size: 2em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .results-count-badge {
            background: rgba(0, 217, 255, 0.2);
            color: #00d9ff;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            border: 1px solid rgba(0, 217, 255, 0.3);
        }

        .results-stats {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .stat {
            background: rgba(20, 30, 60, 0.6);
            border: 1px solid rgba(0, 217, 255, 0.2);
            color: #e0e0e0;
            padding: 15px 20px;
            border-radius: 10px;
            flex: 1;
            min-width: 150px;
        }

        .stat-label {
            font-size: 0.85em;
            color: #a0a0a0;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: 700;
            color: #00d9ff;
        }

        .competitors-list {
            margin-top: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .competitor-item {
            background: rgba(20, 30, 60, 0.6);
            border: 2px solid rgba(0, 217, 255, 0.2);
            padding: 20px;
            border-radius: 12px;
            transition: all 0.3s ease;
            position: relative;
        }

        .competitor-item:hover {
            border-color: #00d9ff;
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 217, 255, 0.2);
        }

        .competitor-item.target {
            border-color: #00d9ff;
            background: rgba(0, 217, 255, 0.05);
        }

        .competitor-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0, 217, 255, 0.2);
            color: #00d9ff;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            border: 1px solid rgba(0, 217, 255, 0.3);
        }

        .competitor-icon {
            width: 40px;
            height: 40px;
            background: rgba(0, 217, 255, 0.1);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .competitor-name {
            font-size: 1.2em;
            font-weight: 600;
            color: #e0e0e0;
            margin-bottom: 8px;
        }

        .competitor-url {
            color: #00d9ff;
            text-decoration: none;
            font-size: 0.9em;
            display: block;
            margin-bottom: 10px;
            word-break: break-all;
        }

        .competitor-url:hover {
            text-decoration: underline;
        }

        .competitor-description {
            color: #a0a0a0;
            font-size: 0.85em;
            line-height: 1.5;
            margin-top: 10px;
        }

        .error {
            display: none;
            background: rgba(220, 53, 69, 0.1);
            border: 1px solid rgba(220, 53, 69, 0.3);
            color: #ff6b6b;
            padding: 15px 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 4px solid #dc3545;
        }

        .error.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        .success-badge {
            display: inline-block;
            background: #4caf50;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            margin-left: 10px;
        }

        .research-status {
            margin-top: 10px;
            font-size: 0.85em;
            color: #a0a0a0;
            padding: 8px 12px;
            background: rgba(160, 160, 160, 0.1);
            border-radius: 6px;
        }

        .research-status.success {
            color: #4ade80;
            background: rgba(74, 222, 128, 0.1);
        }

        .research-status.error {
            color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
        }

        .loading-status {
            margin-top: 10px;
            font-size: 0.9em;
            color: #00d9ff;
            font-weight: 500;
        }

        .competitor-item.analyzing {
            border-color: rgba(255, 193, 7, 0.5);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .completion-message {
            background: rgba(74, 222, 128, 0.1);
            border: 1px solid rgba(74, 222, 128, 0.3);
            color: #4ade80;
            padding: 15px 20px;
            border-radius: 10px;
            margin-top: 30px;
            text-align: center;
            font-weight: 600;
            display: none;
        }

        .completion-message.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        .graphs-section {
            margin-top: 60px;
            display: none;
        }

        .graphs-section.active {
            display: block;
            animation: fadeIn 0.5s ease-in;
        }

        .graphs-header {
            margin-bottom: 40px;
        }

        .graphs-header h2 {
            color: #e0e0e0;
            font-size: 2em;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .graphs-header p {
            color: #a0a0a0;
            font-size: 0.95em;
        }

        .graph-container {
            background: rgba(20, 30, 60, 0.6);
            border: 1px solid rgba(0, 217, 255, 0.2);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .graph-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #e0e0e0;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .graph-title-icon {
            width: 32px;
            height: 32px;
            background: rgba(0, 217, 255, 0.1);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #00d9ff;
            font-size: 1.2em;
        }

        .graph-wrapper {
            position: relative;
            height: 350px;
        }

        .no-data-message {
            text-align: center;
            color: #6b7280;
            padding: 40px 20px;
            font-style: italic;
        }

        .disclaimer {
            text-align: center;
            color: #6b7280;
            font-size: 0.85em;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1px solid rgba(0, 217, 255, 0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-container">
                <div class="logo-icon"></div>
                <h1>Competitor Spy</h1>
            </div>
            <p class="subtitle">Enter a company's website to discover their competitors and analyze market trends</p>
        </div>
        
        <form id="researchForm" class="search-section">
            <div class="form-group">
                <div class="search-input-wrapper">
                    <div class="search-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                        </svg>
                    </div>
                    <input 
                        type="url" 
                        id="companyUrl" 
                        name="url" 
                        placeholder="Enter company website (e.g., stripe.com)" 
                        required
                        autocomplete="off"
                    >
                </div>
            </div>
            <button type="submit" class="btn" id="researchBtn">
                <span class="btn-icon"></span>
                Search
            </button>
        </form>

        <div class="ready-section" id="readySection">
            <div class="ready-icon">üìà</div>
            <div class="ready-text">Ready to Analyze</div>
            <p class="ready-description">Enter a company website above to discover competitors and view market insights including net worth, user growth, and funding trends.</p>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p id="loadingText" style="color: #e0e0e0; margin-top: 15px;">Analyzing company and finding competitors...</p>
            <div class="loading-status" id="loadingStatus"></div>
        </div>

        <div class="error" id="error"></div>

        <div class="results" id="results">
            <div class="results-header">
                <h2>Competitive Landscape <span class="results-count-badge" id="countBadge"></span></h2>
                <div class="results-stats" id="stats"></div>
            </div>
            <div class="competitors-list" id="competitorsList"></div>
            <div class="completion-message" id="completionMessage">
                ‚úì Analysis Complete!
            </div>
        </div>

        <div class="graphs-section" id="graphsSection">
            <div class="graphs-header">
                <h2>Market Analysis</h2>
                <p>Data visualization across all competitors</p>
            </div>
            
            <div class="graph-container">
                <div class="graph-title">
                    <div class="graph-title-icon">$</div>
                    $ Net Worth Timeline
                </div>
                <div class="graph-wrapper">
                    <canvas id="networthChart"></canvas>
                </div>
            </div>

            <div class="graph-container">
                <div class="graph-title">
                    <div class="graph-title-icon">üë•</div>
                    User Growth
                </div>
                <div class="graph-wrapper">
                    <canvas id="usersChart"></canvas>
                </div>
            </div>

            <div class="graph-container">
                <div class="graph-title">
                    <div class="graph-title-icon">‚Üë</div>
                    Funding Rounds
                </div>
                <div class="graph-wrapper">
                    <canvas id="fundingChart"></canvas>
                </div>
            </div>

            <div class="disclaimer">
                Data shown is for demonstration purposes. Connect to real data sources for accurate competitive intelligence.
            </div>
        </div>
    </div>

    <script>
        const form = document.getElementById('researchForm');
        const companyUrlInput = document.getElementById('companyUrl');
        const researchBtn = document.getElementById('researchBtn');
        const loading = document.getElementById('loading');
        const loadingText = document.getElementById('loadingText');
        const loadingStatus = document.getElementById('loadingStatus');
        const error = document.getElementById('error');
        const results = document.getElementById('results');
        const stats = document.getElementById('stats');
        const competitorsList = document.getElementById('competitorsList');
        const completionMessage = document.getElementById('completionMessage');
        const readySection = document.getElementById('readySection');
        const countBadge = document.getElementById('countBadge');

        // Store state
        let competitorsMap = new Map();
        let researchResultsMap = new Map();
        let totalFound = 0;
        let totalSaved = 0;
        let eventSource = null;
        
        // Chart instances
        let networthChart = null;
        let usersChart = null;
        let fundingChart = null;
        
        // Chart data storage
        let chartData = {
            networth: new Map(), // competitor_id -> [{year, value}, ...]
            users: new Map(),
            funding: new Map()
        };

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const url = companyUrlInput.value.trim();
            if (!url) {
                showError('Please enter a valid URL');
                return;
            }

            // Reset UI
            hideError();
            hideResults();
            hideCompletion();
            hideReadySection();
            showLoading();
            researchBtn.disabled = true;
            competitorsMap.clear();
            researchResultsMap.clear();
            totalFound = 0;
            totalSaved = 0;
            chartData.networth.clear();
            chartData.users.clear();
            chartData.funding.clear();
            document.getElementById('graphsSection').classList.remove('active');
            updateLoadingText('Analyzing company and finding competitors...');
            
            // Reset charts
            if (networthChart) {
                networthChart.data.labels = [];
                networthChart.data.datasets = [];
                networthChart.update();
            }
            if (usersChart) {
                usersChart.data.labels = [];
                usersChart.data.datasets = [];
                usersChart.update();
            }
            if (fundingChart) {
                fundingChart.data.labels = [];
                fundingChart.data.datasets = [];
                fundingChart.update();
            }

            try {
                // Use EventSource with GET request (URL as query parameter)
                // Since EventSource doesn't support POST, we'll use a workaround
                const encodedUrl = encodeURIComponent(url);
                eventSource = new EventSource(`/api/competitors/?url=${encodedUrl}`);

                eventSource.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        handleStreamEvent(data);
                    } catch (err) {
                        console.error('Error parsing event data:', err);
                    }
                };

                eventSource.onerror = (err) => {
                    console.error('EventSource error:', err);
                    if (eventSource.readyState === EventSource.CLOSED) {
                        eventSource.close();
                        hideLoading();
                        researchBtn.disabled = false;
                        if (competitorsMap.size === 0) {
                            showError('Connection closed unexpectedly. Please try again.');
                        }
                    }
                };

            } catch (err) {
                showError(err.message || 'Failed to start research. Please try again.');
                hideLoading();
                researchBtn.disabled = false;
            }
        });

        function handleStreamEvent(data) {
            switch (data.type) {
                case 'status':
                    updateLoadingText(data.message);
                    break;
                
                case 'competitors_list':
                    totalFound = data.total || 0;
                    updateStats();
                    break;
                
                case 'competitor':
                    addCompetitor(data.competitor);
                    break;
                
                case 'research_status':
                    updateCompetitorResearchStatus(data.competitor_id, 'analyzing', data.competitor_name);
                    break;
                
                case 'competitor_research':
                    updateCompetitorResearchResult(data.result);
                    break;
                
                case 'complete':
                    handleComplete(data);
                    break;
                
                case 'error':
                    showError(data.error || 'An error occurred');
                    if (eventSource) {
                        eventSource.close();
                    }
                    hideLoading();
                    researchBtn.disabled = false;
                    break;
            }
        }

        function addCompetitor(competitor) {
            // Use a unique key for each competitor
            const key = competitor.id || competitor.name || `competitor_${competitorsMap.size}`;
            
            competitorsMap.set(key, competitor);
            if (!competitor.error && competitor.id) {
                totalSaved++;
            }
            
            updateStats();
            renderCompetitors();
            showResults();
        }

        function updateCompetitorResearchStatus(competitorId, status, competitorName) {
            if (!competitorId) return;
            
            // Try to find competitor by ID or name
            let competitor = competitorsMap.get(competitorId);
            if (!competitor) {
                // Try to find by iterating (in case ID format doesn't match)
                for (let [key, comp] of competitorsMap.entries()) {
                    if (comp.id === competitorId || comp.name === competitorName) {
                        competitor = comp;
                        break;
                    }
                }
            }
            
            if (competitor) {
                competitor.researchStatus = status;
                renderCompetitors();
            }
            
            if (status === 'analyzing') {
                updateLoadingText(`Analyzing ${competitorName || 'competitor'}...`);
            }
        }

        function updateCompetitorResearchResult(result) {
            if (!result.competitor_id) return;
            
            researchResultsMap.set(result.competitor_id, result);
            
            // Try to find competitor by ID
            let competitor = competitorsMap.get(result.competitor_id);
            if (!competitor) {
                // Try to find by iterating
                for (let [key, comp] of competitorsMap.entries()) {
                    if (comp.id === result.competitor_id || comp.name === result.competitor_name) {
                        competitor = comp;
                        break;
                    }
                }
            }
            
            if (competitor) {
                competitor.researchStatus = result.status;
                competitor.researchResult = result;
                renderCompetitors();
            }
            
            // Update charts immediately when research data is available
            if (result.status === 'success' && (result.networth || result.users || result.funding)) {
                updateChartsWithData(result.competitor_id, result.competitor_name, result);
            }
        }

        function handleComplete(data) {
            totalFound = data.total_found || 0;
            totalSaved = data.total_saved || 0;
            
            if (data.research_results) {
                data.research_results.forEach(result => {
                    researchResultsMap.set(result.competitor_id, result);
                    // Update charts with any data that wasn't streamed
                    if (result.status === 'success' && result.networth && result.users && result.funding) {
                        updateChartsWithData(result.competitor_id, result.competitor_name, result);
                    }
                });
            }
            
            updateStats();
            renderCompetitors();
            hideLoading();
            showCompletion();
            researchBtn.disabled = false;
            
            if (eventSource) {
                eventSource.close();
            }
        }

        function renderCompetitors() {
            if (competitorsMap.size === 0) {
                competitorsList.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 40px;">No competitors found yet...</p>';
                return;
            }

            // Update count badge
            if (countBadge) {
                countBadge.textContent = `${competitorsMap.size} companies`;
            }

            // Get target company (first one added, or mark with target badge)
            const competitors = Array.from(competitorsMap.values());
            const targetCompanyId = competitors.length > 0 ? (competitors[0].id || competitors[0].name) : null;

            competitorsList.innerHTML = competitors.map((competitor, index) => {
                const hasError = competitor.error ? 'error' : '';
                const isTarget = index === 0 || competitor.id === targetCompanyId;
                const isAnalyzing = competitor.researchStatus === 'analyzing';
                const researchStatus = getResearchStatus(competitor.id, competitor.researchResult);
                const competitorKey = competitor.id || competitor.name || 'unknown';
                
                return `
                    <div class="competitor-item ${isTarget ? 'target' : ''} ${isAnalyzing ? 'analyzing' : ''}" data-id="${competitorKey}">
                        ${isTarget ? '<span class="competitor-badge">TARGET</span>' : ''}
                        <div class="competitor-icon">üìÑ</div>
                        <div class="competitor-name">
                            ${escapeHtml(competitor.name || 'Unknown')}
                        </div>
                        ${competitor.url ? `
                            <a href="${escapeHtml(competitor.url)}" target="_blank" class="competitor-url">
                                ${escapeHtml(competitor.url)}
                            </a>
                        ` : '<span style="color: #6b7280;">No URL available</span>'}
                        ${competitor.description ? `
                            <div class="competitor-description">${escapeHtml(competitor.description)}</div>
                        ` : ''}
                        ${hasError ? `<div class="research-status error">Error: ${escapeHtml(competitor.error)}</div>` : ''}
                        ${isAnalyzing ? '<div class="research-status">‚è≥ Analyzing...</div>' : ''}
                        ${researchStatus ? `<div class="research-status ${researchStatus.class}">${researchStatus.text}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function updateStats() {
            stats.innerHTML = `
                <div class="stat">
                    <div class="stat-label">Total Found</div>
                    <div class="stat-value">${totalFound}</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Saved to Database</div>
                    <div class="stat-value">${totalSaved}</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Researching</div>
                    <div class="stat-value">${Array.from(competitorsMap.values()).filter(c => c.researchStatus === 'analyzing').length}</div>
                </div>
            `;
        }

        function getResearchStatus(competitorId, directResult) {
            if (!competitorId) return null;
            
            const result = directResult || researchResultsMap.get(competitorId);
            if (!result) return null;

            if (result.status === 'success') {
                const counts = [];
                if (result.networth_count > 0) counts.push(`${result.networth_count} networth`);
                if (result.users_count > 0) counts.push(`${result.users_count} users`);
                if (result.funding_count > 0) counts.push(`${result.funding_count} funding`);
                return {
                    class: 'success',
                    text: `‚úì Research complete: ${counts.join(', ')} records saved`
                };
            } else if (result.status === 'failed' || result.status === 'error') {
                return {
                    class: 'error',
                    text: `‚úó Research failed: ${result.error || 'Unknown error'}`
                };
            }
            return null;
        }

        function showLoading() {
            loading.classList.add('active');
        }

        function hideLoading() {
            loading.classList.remove('active');
        }

        function updateLoadingText(text) {
            loadingText.textContent = text;
        }

        function showError(message) {
            error.textContent = message;
            error.classList.add('active');
        }

        function hideError() {
            error.classList.remove('active');
        }

        function showResults() {
            results.classList.add('active');
        }

        function hideResults() {
            results.classList.remove('active');
        }

        function showCompletion() {
            completionMessage.classList.add('active');
        }

        function hideCompletion() {
            completionMessage.classList.remove('active');
        }

        function showReadySection() {
            readySection.classList.add('active');
        }

        function hideReadySection() {
            readySection.classList.remove('active');
        }

        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

            // Initialize charts
            function initializeCharts() {
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom',
                        labels: {
                            color: '#a0a0a0',
                            padding: 15,
                            font: {
                                size: 12
                            },
                            usePointStyle: true,
                            pointStyle: 'circle'
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(20, 30, 60, 0.95)',
                        titleColor: '#e0e0e0',
                        bodyColor: '#e0e0e0',
                        borderColor: 'rgba(0, 217, 255, 0.3)',
                        borderWidth: 1,
                        padding: 12,
                        cornerRadius: 8
                    }
                },
                scales: {
                    x: {
                        display: true,
                        grid: {
                            color: 'rgba(0, 217, 255, 0.1)',
                            lineWidth: 1
                        },
                        ticks: {
                            color: '#a0a0a0',
                            font: {
                                size: 11
                            }
                        },
                        title: {
                            display: true,
                            text: 'Year',
                            color: '#e0e0e0',
                            font: {
                                size: 12,
                                weight: 'bold'
                            }
                        }
                    },
                    y: {
                        display: true,
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 217, 255, 0.1)',
                            lineWidth: 1
                        },
                        ticks: {
                            color: '#a0a0a0',
                            font: {
                                size: 11
                            }
                        }
                    }
                }
            };

            // Networth Chart
            const networthCtx = document.getElementById('networthChart').getContext('2d');
            networthChart = new Chart(networthCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    ...chartOptions,
                    scales: {
                        ...chartOptions.scales,
                        y: {
                            ...chartOptions.scales.y,
                            title: {
                                display: true,
                                text: 'Networth (USD)',
                                color: '#e0e0e0',
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                callback: function(value) {
                                    if (value >= 1000000) {
                                        return '$' + (value / 1000000).toFixed(1) + 'M';
                                    } else if (value >= 1000) {
                                        return '$' + (value / 1000).toFixed(1) + 'K';
                                    }
                                    return '$' + value;
                                }
                            }
                        }
                    }
                }
            });

            // Users Chart
            const usersCtx = document.getElementById('usersChart').getContext('2d');
            usersChart = new Chart(usersCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    ...chartOptions,
                    scales: {
                        ...chartOptions.scales,
                        y: {
                            ...chartOptions.scales.y,
                            title: {
                                display: true,
                                text: 'Number of Users',
                                color: '#e0e0e0',
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                callback: function(value) {
                                    if (value >= 1000000) {
                                        return (value / 1000000).toFixed(1) + 'M';
                                    } else if (value >= 1000) {
                                        return (value / 1000).toFixed(1) + 'K';
                                    }
                                    return value;
                                }
                            }
                        }
                    }
                }
            });

            // Funding Chart
            const fundingCtx = document.getElementById('fundingChart').getContext('2d');
            fundingChart = new Chart(fundingCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    ...chartOptions,
                    scales: {
                        ...chartOptions.scales,
                        y: {
                            ...chartOptions.scales.y,
                            title: {
                                display: true,
                                text: 'Funding (USD)',
                                color: '#e0e0e0',
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                callback: function(value) {
                                    if (value >= 1000000) {
                                        return '$' + (value / 1000000).toFixed(1) + 'M';
                                    } else if (value >= 1000) {
                                        return '$' + (value / 1000).toFixed(1) + 'K';
                                    }
                                    return '$' + value;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateChartsWithData(competitorId, competitorName, result) {
            let hasData = false;
            
            // Store data
            if (result.networth && Array.isArray(result.networth) && result.networth.length > 0) {
                chartData.networth.set(competitorId, result.networth);
                hasData = true;
            }
            if (result.users && Array.isArray(result.users) && result.users.length > 0) {
                chartData.users.set(competitorId, result.users);
                hasData = true;
            }
            if (result.funding && Array.isArray(result.funding) && result.funding.length > 0) {
                chartData.funding.set(competitorId, result.funding);
                hasData = true;
            }

            // Only update if we have actual data
            if (!hasData) {
                return;
            }

            // Show graphs section immediately when first data arrives
            const graphsSection = document.getElementById('graphsSection');
            if (!graphsSection.classList.contains('active')) {
                graphsSection.classList.add('active');
                // Smooth scroll to graphs when they first appear
                setTimeout(() => {
                    graphsSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 300);
            }

            // Update charts
            updateChart(networthChart, chartData.networth, competitorName, 'Networth');
            updateChart(usersChart, chartData.users, competitorName, 'Users');
            updateChart(fundingChart, chartData.funding, competitorName, 'Funding');
        }

        function updateChart(chart, dataMap, competitorName, dataType) {
            if (!chart || dataMap.size === 0) return;

            // Collect all years from all competitors
            const allYears = new Set();
            dataMap.forEach(dataArray => {
                dataArray.forEach(item => {
                    if (item.year) {
                        allYears.add(item.year);
                    }
                });
            });

            // Sort years
            const sortedYears = Array.from(allYears).sort((a, b) => a - b);

            // Generate colors for each competitor (teal/cyan theme)
            const colors = [
                { border: '#00d9ff', background: 'rgba(0, 217, 255, 0.1)' },
                { border: '#a855f7', background: 'rgba(168, 85, 247, 0.1)' },
                { border: '#10b981', background: 'rgba(16, 185, 129, 0.1)' },
                { border: '#f59e0b', background: 'rgba(245, 158, 11, 0.1)' },
                { border: '#ec4899', background: 'rgba(236, 72, 153, 0.1)' },
                { border: '#3b82f6', background: 'rgba(59, 130, 246, 0.1)' },
                { border: '#8b5cf6', background: 'rgba(139, 92, 246, 0.1)' },
                { border: '#06b6d4', background: 'rgba(6, 182, 212, 0.1)' }
            ];

            // Build datasets for each competitor
            const datasets = [];
            let colorIndex = 0;

            dataMap.forEach((dataArray, compId) => {
                // Get competitor name
                const comp = competitorsMap.get(compId);
                const name = comp ? comp.name : competitorName || `Competitor ${compId}`;

                // Create data points for all years
                const dataPoints = sortedYears.map(year => {
                    const item = dataArray.find(d => d.year === year);
                    return item ? item.value : null;
                });

                // Only add dataset if there's at least one data point
                if (dataPoints.some(v => v !== null)) {
                    const color = colors[colorIndex % colors.length];
                    datasets.push({
                        label: name,
                        data: dataPoints,
                        borderColor: color.border,
                        backgroundColor: color.background,
                        tension: 0.4,
                        fill: false,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        borderWidth: 2.5,
                        pointBackgroundColor: color.border,
                        pointBorderColor: '#0a0e27',
                        pointBorderWidth: 2
                    });
                    colorIndex++;
                }
            });

            // Update chart
            chart.data.labels = sortedYears;
            chart.data.datasets = datasets;
            chart.update('none'); // 'none' mode for smooth updates
        }

        // Initialize charts when page loads
        document.addEventListener('DOMContentLoaded', () => {
            initializeCharts();
            showReadySection();
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (eventSource) {
                eventSource.close();
            }
        });
    </script>
</body>
</html>

